<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
    background: #8b7a50;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    color: #fff;
  }
  h1 {
    margin: 20px 0 10px;
  }
  #home, #game {
    width: 320px;
  }
  .menu-btn {
    background: #5a4826;
    margin: 10px 0;
    padding: 15px;
    border-radius: 12px;
    cursor: pointer;
    user-select: none;
    text-align: center;
    font-size: 18px;
    transition: background 0.3s;
  }
  .menu-btn:hover {
    background: #7d662d;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(7, 40px);
    grid-template-rows: repeat(7, 40px);
    gap: 6px;
    margin: 20px auto;
  }
  .hole {
    width: 40px;
    height: 40px;
    background: linear-gradient(145deg, #c4b68e, #7d6b43);
    border-radius: 50%;
    box-shadow:
      inset 0 2px 5px rgba(255,255,255,0.2),
      inset 0 -2px 5px rgba(0,0,0,0.3),
      2px 2px 5px rgba(0,0,0,0.2);
    position: relative;
  }
  .hole.center {
    box-shadow:
      inset 0 2px 10px rgba(255,255,255,0.5),
      inset 0 -2px 10px rgba(0,0,0,0.5),
      3px 3px 10px rgba(0,0,0,0.4);
  }
  .piece {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    position: absolute;
    top: 5px; left: 5px;
    box-shadow:
      0 0 5px rgba(0,0,0,0.7),
      inset 0 3px 5px rgba(255,255,255,0.3);
  }
  .piece.red {
    background: radial-gradient(circle at 12px 12px, #d94242, #8b2f2f);
  }
  .piece.blue {
    background: radial-gradient(circle at 12px 12px, #2b5fcf, #1c2e72);
  }
  .selected {
    outline: 3px solid #fefefe;
    outline-offset: -3px;
  }
  #status, #levelBox {
    margin: 10px 0;
    min-height: 24px;
    font-weight: bold;
    text-align: center;
  }
  #backBtn {
    margin-top: 10px;
    padding: 8px 14px;
    background: #5a4826;
    border-radius: 10px;
    cursor: pointer;
    text-align: center;
  }
  #backBtn:hover {
    background: #7d662d;
  }
</style>
</head>
<body>

<div id="home">
  <div class="menu-btn" onclick="selectMode('ai')">ğŸ¤– Ø§Ù„Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</div>
  <div class="menu-btn" onclick="selectMode('offline')">ğŸ‘¥ Ø§Ù„Ù„Ø¹Ø¨ Ù…Ø¹ ØµØ¯ÙŠÙ‚ (Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²)</div>
  <div class="menu-btn" onclick="selectMode('online')">ğŸŒ Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
</div>
<div id="designerSignature" style="display:none; position: fixed; bottom: 10px; right: 10px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; color: rgba(115, 80, 60, 0.7); background: rgba(255, 255, 255, 0.3); padding: 6px 12px; border-radius: 10px; box-shadow: 0 0 5px rgba(115, 80, 60, 0.3); user-select: none; z-index: 1200; pointer-events: none;">
  ØªØµÙ…ÙŠÙ… Ø¹Ù„Ø§Ø¡ Ø§Ù„Ø¯ÙŠÙ† Ø³Ø¨Ø§Ù‚ Ù…Ø­Ù…Ø¯ Â®Â©2026
</div>
<div id="game" style="display:none;">
  <div id="levelBox"></div>
  <div id="status"></div>
  <div id="board"></div>
  <div id="backBtn" onclick="goHome()">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
</div>

<audio id="moveSound" src="https://actions.google.com/sounds/v1/foley/footsteps_on_dirt.ogg"></audio>

<script type="module">
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ supabase client Ù…Ù† CDN
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ØªÙ‡ÙŠØ¦Ø© Ø§ØªØµØ§Ù„ Supabase Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©
const SUPABASE_URL = 'https://czmvghwmiaxxyykgcfaj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6bXZnaHdtaWF4eHl5a2djZmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MjY3MjQsImV4cCI6MjA4NTMwMjcyNH0.-A_XCsnqg59s5pLbI1klpicK4GvG1GuEOV8U04W3pE0';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ======== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ========
let mode = ''; // 'ai' or 'offline' or 'online'
let playerName = 'player' + Math.floor(Math.random() * 10000);
let roomId = null;
let isPlayerTurn = true;

const boardSize = 49; // 7x7
let boardState = Array(boardSize).fill(null);
let currentPlayer = 'red'; // Ø§Ù„Ø£Ø­Ù…Ø± ÙŠØ¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ø§Ù‹
let placementPhase = true;
let piecesCount = { red: 24, blue: 24 };
let placementsThisTurn = 0;

const boardDiv = document.getElementById('board');
const statusText = document.getElementById('status');
const levelBox = document.getElementById('levelBox');
const moveSound = document.getElementById('moveSound');

const holes = [];
let selected = null;

// ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„ÙˆØ­Ø© ===========
function setupBoard() {
  boardDiv.innerHTML = '';
  holes.length = 0;
  for (let i = 0; i < boardSize; i++) {
    const hole = document.createElement('div');
    hole.className = 'hole';
    if (i === 24) hole.classList.add('center');
    hole.dataset.index = i;
    hole.onclick = () => handleClick(i);
    boardDiv.appendChild(hole);
    holes.push(hole);
  }
  drawBoard();
}

// ========== Ø±Ø³Ù… Ø§Ù„Ù„ÙˆØ­Ø© ===========
function drawBoard() {
  holes.forEach((hole, i) => {
    hole.innerHTML = '';
    hole.classList.remove('selected');
    if (boardState[i]) {
      const piece = document.createElement('div');
      piece.className = 'piece ' + boardState[i];
      hole.appendChild(piece);
    }
  });
  if (selected !== null) holes[selected].classList.add('selected');
  updateStatus();
}

// ========== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ===========
function updateStatus() {
  if (placementPhase) {
    statusText.textContent = `${currentPlayer === 'red' ? 'Ø£Ù†Øª Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø£Ø²Ø±Ù‚'}: Ø¶Ø¹ Ø­Ø¬Ø±ØªÙŠÙ†`;
  } else {
    statusText.textContent = isPlayerTurn ? 'Ø¯ÙˆØ±Ùƒ' : 'Ø¯ÙˆØ± Ø§Ù„Ø®ØµÙ…';
  }
  if (mode === 'online') {
    levelBox.textContent = `Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†`;
  } else {
    levelBox.textContent = '';
  }
}

// ========== Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± ===========
async function handleClick(i) {
  if (mode === 'online' && !isPlayerTurn) return;
  if (mode === 'ai' && currentPlayer === 'blue') return; // Ù…Ù†Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯Ù…Ø§ Ø¯ÙˆØ± Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
  if (placementPhase) {
    placePiece(i);
  } else {
    movePiece(i);
  }
}

// ========== ÙˆØ¶Ø¹ Ù‚Ø·Ø¹Ø© ===========
async function placePiece(i) {
  if (boardState[i] || i === 24) return;

  boardState[i] = currentPlayer;
  piecesCount[currentPlayer]--;
  placementsThisTurn++;

  playMoveSound();
  drawBoard();

  if (placementsThisTurn === 2) {
    placementsThisTurn = 0;
    if (piecesCount.red <= 0 && piecesCount.blue <= 0) {
      placementPhase = false;
      currentPlayer = 'red';
      statusText.textContent = 'Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©! Ø¯ÙˆØ±Ùƒ.';
      isPlayerTurn = true;
    } else {
      switchTurn();
      if (mode === 'ai' && currentPlayer === 'blue') {
        setTimeout(aiPlacePieces, 800);
      }
    }
  }

  if (mode === 'online') await sendGameState();
}

// ====== ÙˆØ¶Ø¹ Ø­Ø¬Ø§Ø±Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (Ø­Ø¬Ø±ØªÙŠÙ†) =======
async function aiPlacePieces() {
  if (currentPlayer !== 'blue' || !placementPhase) return;

  for (let count = 0; count < 2; count++) { // Ø­Ø· Ø­Ø¬Ø±ØªÙŠÙ†
    let attempts = 0;
    while (attempts < 100) {
      const pos = Math.floor(Math.random() * boardSize);
      if (!boardState[pos] && pos !== 24) {
        boardState[pos] = 'blue';
        piecesCount.blue--;
        placementsThisTurn++;
        playMoveSound();
        drawBoard();
        break;
      }
      attempts++;
    }
    await new Promise(res => setTimeout(res, 600)); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¬Ø§Ø±
  }

  if (piecesCount.blue <= 0 && piecesCount.red <= 0) {
    placementPhase = false;
    currentPlayer = 'red'; // ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø£Ø­Ù…Ø± ÙÙŠ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
    placementsThisTurn = 0;
    statusText.textContent = 'Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø¹Ø±ÙƒØ©! Ø¯ÙˆØ±Ùƒ.';
    isPlayerTurn = true;
  } else {
    switchTurn();
  }
}

// ========== ØªØ­Ø±ÙŠÙƒ Ù‚Ø·Ø¹Ø© ===========
async function movePiece(i) {
  if (selected === null) {
    if (boardState[i] === currentPlayer) {
      selected = i;
      drawBoard();
    }
    return;
  }

  if (!isValidMove(selected, i)) {
    selected = null;
    drawBoard();
    return;
  }

  boardState[i] = currentPlayer;
  boardState[selected] = null;
  selected = null;

  playMoveSound();
  drawBoard();
  capturePieces(i);

  if (checkWin()) {
    alert(currentPlayer === 'red' ? 'ÙØ²Øª!' : 'Ø®Ø³Ø±Øª!');
    resetGame();
    return;
  }

  switchTurn();

  if (mode === 'online') await sendGameState();
  if (mode === 'ai' && currentPlayer === 'blue') {
    setTimeout(aiMove, 800);
  }
}

// ========== ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø­Ø±ÙƒØ© ===========
function isValidMove(from, to) {
  if (boardState[to]) return false;
  const diff = Math.abs(to - from);
  return diff === 1 || diff === 7;
}

// ========== Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· ===========
function capturePieces(pos) {
  const directions = [1, -1, 7, -7];
  directions.forEach(d => {
    const mid = pos + d;
    const end = pos + 2 * d;
    if (
      boardState[mid] && boardState[mid] !== currentPlayer &&
      boardState[end] === currentPlayer
    ) {
      boardState[mid] = null;
    }
  });
}

// ========== Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ===========
function switchTurn() {
  placementsThisTurn = 0;
  currentPlayer = currentPlayer === 'red' ? 'blue' : 'red';
  if (mode === 'online') {
    isPlayerTurn = !isPlayerTurn;
  } else {
    isPlayerTurn = currentPlayer === 'red';
  }
  drawBoard();
}

// ========== ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙˆØ² ===========
function checkWin() {
  if (!boardState.includes('red')) return true;
  if (!boardState.includes('blue')) return true;
  return false;
}

// ========== AI Ø¨Ø³ÙŠØ· ===========
function aiMove() {
  if (currentPlayer !== 'blue') return;

  for (let i = 0; i < boardSize; i++) {
    if (boardState[i] === 'blue') {
      const moves = [i + 1, i - 1, i + 7, i - 7];
      for (const m of moves) {
        if (m >= 0 && m < boardSize && !boardState[m]) {
          boardState[m] = 'blue';
          boardState[i] = null;
          capturePieces(m);
          switchTurn();
          drawBoard();
          setTimeout(() => {
            if (currentPlayer === 'blue') {
              aiMove();
            }
          }, 600);
          return;
        }
      }
    }
  }
  // Ù„Ùˆ Ù…Ø§ Ù„Ù‚Ù‰ Ø­Ø±ÙƒØ©ØŒ ÙŠÙ…Ø±Ø± Ø§Ù„Ø¯ÙˆØ±
  switchTurn();
}

// ========== Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø³ÙŠØ±ÙØ± ===========
async function sendGameState() {
  if (!roomId) return;
  const { error } = await supabase
    .from('rooms')
    .update({
      board: JSON.stringify(boardState),
      turn: currentPlayer
    })
    .eq('id', roomId);
  if (error) console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', error);
}

// ========== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ===========
function listenGameState() {
  if (!roomId) return;
  supabase
    .from(`rooms:id=eq.${roomId}`)
    .on('UPDATE', payload => {
      const newBoard = JSON.parse(payload.new.board);
      const newTurn = payload.new.turn;

      boardState = newBoard;
      currentPlayer = newTurn;
      isPlayerTurn = (playerName === (currentPlayer === 'red' ? payload.new.player1 : payload.new.player2));

      drawBoard();
    })
    .subscribe();
}

// ========== Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ===========
async function joinOnlineGame() {
  const { data: rooms, error } = await supabase
    .from('rooms')
    .select('*')
    .is('player2', null)
    .limit(1);

  if (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØºØ±Ù:', error);
    return;
  }

  if (rooms.length === 0) {
    const { data, error: insertError } = await supabase
      .from('rooms')
      .insert([{
        player1: playerName,
        player2: null,
        board: JSON.stringify(boardState),
        turn: 'red'
      }])
      .select()
      .single();

    if (insertError) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©:', insertError);
      return;
    }

    roomId = data.id;
    isPlayerTurn = true;
    statusText.textContent = 'Ø§Ù†ØªØ¸Ø± Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±...';
    listenGameState();
  } else {
    roomId = rooms[0].id;
    await supabase
      .from('rooms')
      .update({ player2: playerName })
      .eq('id', roomId);

    isPlayerTurn = false;
    listenGameState();
    statusText.textContent = 'Ø¯ÙˆØ± Ø§Ù„Ø®ØµÙ…';
  }
}

// ========== Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹ ===========
function startGame() {
  setupBoard();
  if (mode === 'online') {
    joinOnlineGame();
  } else {
    isPlayerTurn = true;
    drawBoard();
    if (mode === 'ai' && currentPlayer === 'blue' && placementPhase) {
      setTimeout(aiPlacePieces, 800); // Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙŠØ¨Ø¯Ø£ Ø¨ÙˆØ¶Ø¹ Ø­Ø¬Ø§Ø±Ù‡ Ø¨Ø¹Ø¯Ùƒ Ù„Ùˆ Ø¨Ø¯Ø£ Ù‡Ùˆ Ø£Ø²Ø±Ù‚
    }
  }
}

// ========== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===========
function selectMode(selectedMode) {
  mode = selectedMode;
  document.getElementById('home').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  startGame();
}

// ========== Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===========
function goHome() {
  location.reload();
}

// ========== ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø­Ø±ÙƒØ© ===========
function playMoveSound() {
  moveSound.currentTime = 0;
  moveSound.play();
}

// ===== Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
window.selectMode = selectMode;
window.goHome = goHome;

</script
</body>
</html>
<!-- Ø²Ø± ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ -->
<button id="musicToggle" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 15px;
  font-size: 18px;
  border-radius: 8px;
  background: #73503c;
  color: white;
  border: none;
  cursor: pointer;
  user-select: none;
  z-index: 1100;
">
  ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
</button>

<!-- Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© -->
<audio id="backgroundMusic" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_41f6d278b4.mp3?filename=relaxing-meditation-11265.mp3" loop></audio>

<script>
  const musicToggle = document.getElementById('musicToggle');
  const backgroundMusic = document.getElementById('backgroundMusic');

  let musicPlaying = false;

  musicToggle.addEventListener('click', () => {
    if (musicPlaying) {
      backgroundMusic.pause();
      musicToggle.textContent = 'ğŸ”‡ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰';
    } else {
      backgroundMusic.play();
      musicToggle.textContent = 'ğŸ”Š ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰';
    }
    musicPlaying = !musicPlaying;
  });
</script>
<!-- Ø¹Ø¯Ø§Ø¯ Level ØµØºÙŠØ± ØªØ­Øª Ø§Ù„ÙŠØ³Ø§Ø± -->
<div id="levelDisplay" style="
  position: fixed;
  bottom: 15px;
  left: 15px;
  background: rgba(115, 80, 60, 0.8);
  color: white;
  padding: 6px 12px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 8px;
  user-select: none;
  z-index: 1100;
  font-family: Arial, sans-serif;
  width: 60px;
  text-align: center;
">
  Level: 0
</div>